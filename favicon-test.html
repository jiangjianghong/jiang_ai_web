<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Favicon è·å–æµ‹è¯•</title>
    <!-- é˜»æ­¢åŠ è½½Reactç›¸å…³èµ„æº -->
    <script>
        // é˜»æ­¢Viteå¼€å‘æœåŠ¡å™¨çš„HMRè¿æ¥
        if (window.location.hostname === 'localhost') {
            window.__vite_is_modern_browser = false;
        }
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-item {
            background: white;
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .favicon {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .domain {
            font-weight: bold;
            color: #333;
        }
        .status {
            margin-left: auto;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .success { background: #d4edda; color: #155724; }
        .loading { background: #fff3cd; color: #856404; }
        .error { background: #f8d7da; color: #721c24; }
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .stats {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>ğŸ¯ Favicon è·å–ç­–ç•¥æµ‹è¯•</h1>
    
    <div class="controls">
        <button onclick="testAllFavicons()">ğŸš€ æµ‹è¯•æ‰€æœ‰åŸŸå</button>
        <button onclick="clearCache()">ğŸ—‘ï¸ æ¸…é™¤ç¼“å­˜</button>
        <button onclick="showStats()">ğŸ“Š æ˜¾ç¤ºç»Ÿè®¡</button>
    </div>

    <div class="stats" id="stats">
        <strong>æµ‹è¯•ç»Ÿè®¡:</strong> ç­‰å¾…æµ‹è¯•...
    </div>

    <div id="test-results">
        <!-- æµ‹è¯•ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
    </div>

    <script>
        // æµ‹è¯•åŸŸååˆ—è¡¨
        const testDomains = [
            'github.com',
            'google.com',
            'microsoft.com',
            'apple.com',
            'amazon.com',
            'facebook.com',
            'twitter.com',
            'linkedin.com',
            'stackoverflow.com',
            'reddit.com',
            'youtube.com',
            'netflix.com',
            'spotify.com',
            'discord.com',
            'notion.so',
            'figma.com',
            'vercel.com',
            'netlify.com',
            'cloudflare.com',
            'aws.amazon.com'
        ];

        let testResults = {};
        let startTime = 0;

        // è·å–faviconçš„å¤šç§ç­–ç•¥
        function getFaviconUrls(domain) {
            return [
                `https://www.google.com/s2/favicons?domain=${domain}&sz=32`,
                `https://icons.duckduckgo.com/ip3/${domain}.ico`,
                `https://${domain}/favicon.ico`,
                `https://corsproxy.io/?${encodeURIComponent(`https://favicon.im/${domain}?size=32`)}`
            ];
        }

        // æµ‹è¯•å•ä¸ªåŸŸåçš„faviconè·å–
        async function testFavicon(domain) {
            const urls = getFaviconUrls(domain);
            const resultDiv = document.getElementById(`result-${domain}`);
            const statusDiv = resultDiv.querySelector('.status');
            const imgElement = resultDiv.querySelector('.favicon');
            
            statusDiv.textContent = 'åŠ è½½ä¸­...';
            statusDiv.className = 'status loading';
            
            for (let i = 0; i < urls.length; i++) {
                const url = urls[i];
                try {
                    console.log(`ğŸ”„ [${i + 1}/${urls.length}] æµ‹è¯• ${domain}: ${getUrlDescription(url)}`);
                    
                    const response = await fetch(url, {
                        mode: 'cors',
                        credentials: 'omit',
                        headers: {
                            'Accept': 'image/*,*/*;q=0.8'
                        },
                        signal: AbortSignal.timeout(5000)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const blob = await response.blob();
                    
                    if (blob.size < 50) {
                        throw new Error(`æ–‡ä»¶å¤ªå° (${blob.size} bytes)`);
                    }

                    // æˆåŠŸè·å–
                    const blobUrl = URL.createObjectURL(blob);
                    imgElement.src = blobUrl;
                    imgElement.onload = () => {
                        statusDiv.textContent = `âœ… æˆåŠŸ (${getUrlDescription(url)})`;
                        statusDiv.className = 'status success';
                        testResults[domain] = { success: true, source: getUrlDescription(url), size: blob.size };
                        updateStats();
                    };
                    imgElement.onerror = () => {
                        throw new Error('å›¾ç‰‡åŠ è½½å¤±è´¥');
                    };
                    return;
                    
                } catch (error) {
                    console.log(`âŒ [${i + 1}/${urls.length}] ${domain} å¤±è´¥: ${error.message}`);
                    continue;
                }
            }
            
            // æ‰€æœ‰å°è¯•å¤±è´¥
            imgElement.src = '/icon/icon.jpg';
            statusDiv.textContent = 'âŒ å…¨éƒ¨å¤±è´¥';
            statusDiv.className = 'status error';
            testResults[domain] = { success: false, source: 'none' };
            updateStats();
        }

        function getUrlDescription(url) {
            if (url.includes('google.com/s2/favicons')) return 'Google';
            if (url.includes('icons.duckduckgo.com')) return 'DuckDuckGo';
            if (url.includes('corsproxy.io')) return 'CORS Proxy';
            if (url.includes('/favicon.')) return 'Direct';
            return 'Other';
        }

        // åˆ›å»ºæµ‹è¯•ç»“æœæ˜¾ç¤º
        function createTestResults() {
            const container = document.getElementById('test-results');
            container.innerHTML = '';
            
            testDomains.forEach(domain => {
                const div = document.createElement('div');
                div.className = 'test-item';
                div.id = `result-${domain}`;
                div.innerHTML = `
                    <img class="favicon" src="/icon/icon.jpg" alt="${domain}">
                    <span class="domain">${domain}</span>
                    <span class="status">ç­‰å¾…æµ‹è¯•</span>
                `;
                container.appendChild(div);
            });
        }

        // æµ‹è¯•æ‰€æœ‰favicon
        async function testAllFavicons() {
            testResults = {};
            startTime = Date.now();
            createTestResults();
            updateStats();
            
            console.log('ğŸš€ å¼€å§‹æµ‹è¯•æ‰€æœ‰åŸŸåçš„ favicon è·å–');
            
            // åˆ†æ‰¹æµ‹è¯•ï¼Œé¿å…è¿‡å¤šå¹¶å‘è¯·æ±‚
            const batchSize = 3;
            for (let i = 0; i < testDomains.length; i += batchSize) {
                const batch = testDomains.slice(i, i + batchSize);
                const promises = batch.map(domain => testFavicon(domain));
                await Promise.allSettled(promises);
                
                // æ‰¹æ¬¡é—´å»¶è¿Ÿ
                if (i + batchSize < testDomains.length) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            
            console.log('âœ… æ‰€æœ‰æµ‹è¯•å®Œæˆ');
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const total = Object.keys(testResults).length;
            const successful = Object.values(testResults).filter(r => r.success).length;
            const failed = total - successful;
            const elapsed = startTime ? ((Date.now() - startTime) / 1000).toFixed(1) : 0;
            
            const sources = {};
            Object.values(testResults).forEach(result => {
                if (result.success) {
                    sources[result.source] = (sources[result.source] || 0) + 1;
                }
            });
            
            const sourceStats = Object.entries(sources)
                .map(([source, count]) => `${source}: ${count}`)
                .join(', ');
            
            document.getElementById('stats').innerHTML = `
                <strong>æµ‹è¯•ç»Ÿè®¡:</strong> 
                æ€»è®¡: ${total}, æˆåŠŸ: ${successful}, å¤±è´¥: ${failed}, 
                ç”¨æ—¶: ${elapsed}s<br>
                <strong>æˆåŠŸæ¥æº:</strong> ${sourceStats || 'æ— '}
            `;
        }

        // æ¸…é™¤ç¼“å­˜
        function clearCache() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç¼“å­˜å—ï¼Ÿ')) {
                // æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼ˆæ¨¡æ‹Ÿï¼‰
                location.reload();
            }
        }

        // æ˜¾ç¤ºè¯¦ç»†ç»Ÿè®¡
        function showStats() {
            const stats = Object.entries(testResults)
                .map(([domain, result]) => `${domain}: ${result.success ? 'âœ…' : 'âŒ'} ${result.source}`)
                .join('\n');
            alert('è¯¦ç»†ç»Ÿè®¡:\n\n' + stats);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆ›å»ºæµ‹è¯•ç•Œé¢
        document.addEventListener('DOMContentLoaded', () => {
            createTestResults();
        });
    </script>
</body>
</html>