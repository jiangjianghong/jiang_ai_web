<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>江的标签页</title>
    
    <!-- GitHub Pages SPA 重定向脚本 -->
    <script>
      // 处理 GitHub Pages SPA 路由
      (function(l) {
        if (l.search[1] === '/' ) {
          var decoded = l.search.slice(1).split('&').map(function(s) { 
            return s.replace(/~and~/g, '&')
          }).join('?');
          window.history.replaceState(null, null,
              l.pathname.slice(0, -1) + decoded + l.hash
          );
        }
      }(window.location))
    </script>
    
    <!-- 预连接到重要的第三方域名 - 使用国内可访问的CDN -->
    <link rel="preconnect" href="https://cdn.bootcdn.net" />
    <link rel="preconnect" href="https://unpkg.com" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" />
    <link rel="preconnect" href="https://lib.baomitu.com" />
    
    <!-- 使用多个备用CDN加载FontAwesome -->
    <script>
      // 动态加载FontAwesome，支持多个CDN备选（按速度排序）
      const fontAwesomeCDNs = [
        'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css',
        'https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css',
        'https://lib.baomitu.com/font-awesome/6.4.0/css/all.min.css',
        'https://unpkg.com/@fortawesome/fontawesome-free@6.4.0/css/all.min.css'
      ];
      
      function loadFontAwesome(urls, index = 0) {
        if (index >= urls.length) {
          console.warn('所有FontAwesome CDN都无法加载，使用系统图标');
          return;
        }
        
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = urls[index];
        link.crossOrigin = 'anonymous';
        
        link.onload = () => {
          console.log('✅ FontAwesome加载成功:', urls[index]);
          // 预加载字体文件以提升渲染速度
          const fontUrl = urls[index].replace('/css/all.min.css', '/webfonts/fa-solid-900.woff2');
          const fontLink = document.createElement('link');
          fontLink.rel = 'preload';
          fontLink.as = 'font';
          fontLink.type = 'font/woff2';
          fontLink.crossOrigin = 'anonymous';
          fontLink.href = fontUrl;
          document.head.appendChild(fontLink);
        };
        
        link.onerror = () => {
          console.log('❌ FontAwesome加载失败:', urls[index]);
          loadFontAwesome(urls, index + 1);
        };
        
        document.head.appendChild(link);
      }
      
      loadFontAwesome(fontAwesomeCDNs);
    </script>
    
    <!-- 备用样式 - 如果FontAwesome失败，使用Unicode符号 -->
    <style>
      /* 基本图标备选方案 */
      .fa-search:before { content: "🔍"; }
      .fa-home:before { content: "🏠"; }
      .fa-user:before { content: "👤"; }
      .fa-cog:before, .fa-gear:before { content: "⚙️"; }
      .fa-plus:before { content: "➕"; }
      .fa-minus:before { content: "➖"; }
      .fa-edit:before { content: "✏️"; }
      .fa-trash:before { content: "🗑️"; }
      .fa-save:before { content: "💾"; }
      .fa-download:before { content: "⬇️"; }
      .fa-upload:before { content: "⬆️"; }
      .fa-link:before { content: "🔗"; }
      .fa-check:before { content: "✅"; }
      .fa-times:before, .fa-close:before { content: "❌"; }
      .fa-heart:before { content: "❤️"; }
      .fa-star:before { content: "⭐"; }
    </style>
    
    <!-- DNS预取常用域名 -->
    <link rel="dns-prefetch" href="//cdn.bootcdn.net" />
    <link rel="dns-prefetch" href="//unpkg.com" />
    <link rel="dns-prefetch" href="//fonts.googleapis.com" />
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com" />
    <link rel="dns-prefetch" href="//lib.baomitu.com" />
    <link rel="dns-prefetch" href="//api.github.com" />
    
    <!-- 预连接Supabase -->
    <link rel="preconnect" href="https://wxheqargopbsrruootyr.supabase.co" />
    
    <!-- 网站图标 - 蜡笔小新 -->
    <link rel="icon" type="image/png" href="/icon/favicon.png" />
    <link rel="shortcut icon" type="image/png" href="/icon/favicon.png" />
    <link rel="apple-touch-icon" href="/icon/favicon.png" />
  </head>
  <body>
    <!-- React应用根节点 -->
    <div id="root">
      

      
      <style>
        /* 关键CSS内联 - 避免FOUC */
        * {
          box-sizing: border-box;
        }
        
        body {
          margin: 0;
          padding: 0;
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
          background: #f0f0f0;
          min-height: 100vh;
          overflow-x: hidden;
          /* 优化字体渲染 */
          -webkit-font-smoothing: antialiased;
          -moz-osx-font-smoothing: grayscale;
          text-rendering: optimizeLegibility;
        }
        
        #root {
          width: 100%;
          min-height: 100vh;
        }
        

        
        /* 减少动画以节省电池 */
        @media (prefers-reduced-motion: reduce) {
          #loading-skeleton {
            animation-duration: 0.5s !important;
          }
        }
        
        /* 预设常用类避免布局抖动 */
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .absolute { position: absolute; }
        .relative { position: relative; }
        .fixed { position: fixed; }
        .z-10 { z-index: 10; }
        .opacity-0 { opacity: 0; }
        .opacity-100 { opacity: 1; }
        .transition-opacity { transition-property: opacity; transition-duration: 0.3s; }
      </style>
    </div>
    
    <script type="module" src="/src/main.tsx"></script>
    

    
    <!-- Service Worker 注册（支持离线运行） -->
    <script>
      // 检测是否离线
      function updateOnlineStatus() {
        if (!navigator.onLine) {
          console.log('📴 当前处于离线状态');
          document.body.classList.add('offline-mode');
        } else {
          console.log('📶 已连接到网络');
          document.body.classList.remove('offline-mode');
        }
      }

      window.addEventListener('online', updateOnlineStatus);
      window.addEventListener('offline', updateOnlineStatus);
      updateOnlineStatus();

      // Service Worker 注册
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          // 根据环境选择Service Worker
          const swFile = 'sw-enhanced.js';
          const swPath = `./${swFile}?v=${Date.now()}`;
          
          console.log('🔧 注册Service Worker:', swPath);
          
          navigator.serviceWorker.register(swPath)
            .then((registration) => {
              console.log('✅ Service Worker 注册成功');
              
              // 监听更新
              registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                
                newWorker.addEventListener('statechange', () => {
                  if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    console.log('🔄 新版本可用，刷新页面更新');
                    // 可以在这里提示用户刷新页面
                  }
                });
              });
              
              // 定期检查更新
              setInterval(() => {
                registration.update();
              }, 60 * 60 * 1000); // 每小时检查一次
            })
            .catch((error) => {
              console.error('❌ Service Worker 注册失败:', error);
              // 回退到基础Service Worker
              navigator.serviceWorker.register('./sw.js')
                .then(() => console.log('✅ 回退到基础Service Worker'))
                .catch(() => console.log('❌ 所有Service Worker都失败'));
            });
          
          // 处理Service Worker消息
          navigator.serviceWorker.addEventListener('message', event => {
            console.log('📨 收到Service Worker消息:', event.data);
          });
        });
      } else {
        console.log('⚠️ 浏览器不支持Service Worker，离线功能不可用');
      }
      
      // PWA安装提示
      let deferredPrompt;
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        console.log('📱 可以安装为PWA应用');
        // 可以在这里显示安装按钮
      });
    </script>
    
    <!-- 离线状态样式 -->
    <style>
      .offline-mode::before {
        content: "离线模式";
        position: fixed;
        top: 10px;
        right: 10px;
        background: #ff9800;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        z-index: 9999;
        animation: pulse 2s infinite;
      }
      
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
      }
    </style>
  </body>
</html>
